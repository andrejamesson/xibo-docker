services:
    cms-db:
        image: mysql:8.0
        # ATENÃ‡ÃƒO: Verifique a documentaÃ§Ã£o do Dokploy sobre Volumes Persistentes.
        volumes:
            - "./shared/db:/var/lib/mysql:Z"
        environment:
            - MYSQL_DATABASE=cms
            - MYSQL_USER=cms
            - MYSQL_RANDOM_ROOT_PASSWORD=yes
        
        # ðŸŒŸ ADICIONADO HEALTHCHECK ðŸŒŸ
        healthcheck:
            test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
            timeout: 20s
            retries: 10
            
        mem_limit: 1g
        env_file: config.env
        restart: always
        # Redes e Ports removidos para usar a configuraÃ§Ã£o padrÃ£o do Dokploy

    cms-xmr:
        image: ghcr.io/xibosignage/xibo-xmr:1.0
        ports:
            # Manter a porta XMR (9505) Ã© necessÃ¡rio para comunicaÃ§Ã£o interna/externa de Players
            - "9505:9505"
        restart: always
        mem_limit: 256m
        env_file: config.env
        # Redes removidas

    cms-web:
        image: ghcr.io/xibosignage/xibo-cms:release-4.3.0
        # ATENÃ‡ÃƒO: Verifique a documentaÃ§Ã£o do Dokploy sobre Volumes Persistentes.
        volumes:
            - "./shared/cms/custom:/var/www/cms/custom:Z"
            - "./shared/backup:/var/www/backup:Z"
            - "./shared/cms/web/theme/custom:/var/www/cms/web/theme/custom:Z"
            - "./shared/cms/library:/var/www/cms/library:Z"
            - "./shared/cms/web/userscripts:/var/www/cms/web/userscripts:Z"
            - "./shared/cms/ca-certs:/var/www/cms/ca-certs:Z"
            
        # ðŸŒŸ AJUSTADO RESTART E ADICIONADO DEPENDS_ON ðŸŒŸ
        restart: on-failure # Reinicia apenas se houver falha (mais seguro com healthcheck)
        depends_on:
            cms-db:
                condition: service_healthy # Espera o MySQL passar no healthcheck
            cms-xmr:
                condition: service_started
            cms-memcached:
                condition: service_started

        environment:
            - MYSQL_HOST=cms-db
            - XMR_HOST=cms-xmr
            - CMS_USE_MEMCACHED=true
            - MEMCACHED_HOST=cms-memcached
        env_file: config.env
            
        mem_limit: 1g
        # Redes removidas

    cms-memcached:
        image: memcached:alpine
        command: memcached -m 15
        restart: always
        mem_limit: 100M
        # Redes removidas

    cms-quickchart:
        image: ianw/quickchart
        restart: always
        # Redes removidas
